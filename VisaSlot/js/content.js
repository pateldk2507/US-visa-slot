function c(e){let t=e.getBoundingClientRect();return{top:t.top,right:t.right,bottom:t.bottom,left:t.left,width:t.width,height:t.height,x:t.x,y:t.y,pixel_scale:window.devicePixelRatio}}function u(e){let t=/\((\d+)\)/.exec(e);return t?t[1]:""}function d(){return document.body.outerText.indexOf("Registered Users")>-1&&document.body.outerText.indexOf("Forgot Your Password?")>-1}async function m(){chrome.storage.local.get(["userProfiles","extVersion","apiKey"],function(e){let t=e["apiKey"];if(e.hasOwnProperty("extVersion")){if(parseFloat(e["extVersion"])!==parseFloat(chrome.runtime.getManifest()["version"])){chrome.storage.local.clear().then(()=>{chrome.storage.local.set({extVersion:chrome.runtime.getManifest()["version"],apiKey:t},()=>{console.log("new extension version")})})}}if(e.hasOwnProperty("userProfiles")){let o=JSON.parse(e["userProfiles"]),a=new Date;for(let[t,n]of Object.entries(o)){let e=new Date(n["createdon"]);if(Math.abs(a-e)>1e3*60*60*24*10){delete o[t]}}chrome.storage.local.set({userProfiles:JSON.stringify(o)})}})}async function A(){let e=new FormData;e.append("portal_id",u(document.querySelector(".username").outerText));const t={headers:{"x-api-key":items["apiKey"],extVersion:items["extVersion"]},method:"POST",body:e};fetch("https://app.checkvisaslots.com"+"/get-user-preferences",t).then()["catch"](e=>{console.log(e)})}let e=window.location.pathname.toLowerCase();if(e.indexOf("/scheduleappointment")>-1){try{let s=setInterval(()=>{let e=document.querySelector('select[name^="thePage:SiteTemplate"]'),t;if(!e){if(d()){m();clearInterval(s)}return}t=c(document.getElementById("dashboard"));let n=document.getElementById("datepicker"),r=[],o=[],a=document.querySelector(".username-display");t["uname_box"]=c(a);a=a.outerText;if(n){try{const i=["ui-datepicker-group ui-datepicker-group-first","ui-datepicker-group ui-datepicker-group-middle","ui-datepicker-group ui-datepicker-group-last"];for(let a of i){let e={},t=document.getElementsByTagName("select")[0],n=[];e["location"]=t[t?.selectedIndex]?.text;e["monthYear"]=datepicker.getElementsByClassName(a)[0]?.firstElementChild?.lastElementChild?.textContent.replace("Â "," ");let o=datepicker.getElementsByClassName(a)[0]?.getElementsByTagName("a");for(let e of o){if(e?.className?.indexOf("ui-state-default ui-state-active")>-1||e?.className?.indexOf("ui-state-default")>-1){n.push(e.textContent)}}if(n.length>0){e["dates"]=n;r.push(e)}}}catch(l){console.log(l)}}else{let e={},t=document.getElementsByTagName("select")[0];e["location"]=t[t?.selectedIndex]?.text;r.push(e)}p(resource="/push/v3",t,r,o,a);clearInterval(s)},200)}catch(M){console.log(M)}}else if(e.indexOf("/applicanthome")>-1){try{let s=setInterval(()=>{let e,t,n,o,a,r,l;try{r=document.querySelector(".username-display").outerText;l=document.querySelectorAll("#dashboard-table > tbody > tr > td")}catch(i){if(d()){m();clearInterval(s)}}if(l){e=l[1].outerText;t=l[4].outerText;n=l[3].outerText}if(!e)return;o={visaDetails:e,userDetails:r,familyDetails:n,apntDetails:t};a=u(r);if(a){chrome.storage.local.get(["userProfiles"],function(e){let t={},n={createdon:new Date};if(e.hasOwnProperty("userProfiles")){t=JSON.parse(e["userProfiles"])}if(!t.hasOwnProperty(a)){t[a]={}}t[a]={...o,...n};chrome.storage.local.set({userProfiles:JSON.stringify(t)},function(){clearInterval(s)})})}},200)}catch(M){console.log(M)}}else if(e.indexOf("/en-us")>-1&&e.length<=9){let e=setInterval(()=>{if(document.readyState==="complete"){clearInterval(e)}else{console.log("waiting for document to load")}},100);n().then(()=>t())}else if(e.indexOf("f50ebcfb-eadd-41d8-9099-a7049d073f5c")>-1){I()}else if(["/","/en-us/"].includes(window.location.pathname.toLowerCase())){m()}else if(e.indexOf("appointment-confirmation")>-1){setTimeout(()=>{a()},1e3)}else if(e.indexOf("/ofc-schedule")>-1){o()}else if(e.indexOf("/schedule")>-1){o()}function t(){let e,t="",n,o,a,r,l;try{r=document.querySelector(".username").outerText;l=document.querySelectorAll(".grid-row.grid-gap-3 li")}catch(i){if(d()){m();clearInterval(timer)}}if(l){e=s(l[0].outerText);e=e[e.length-2];n=s(l[2].outerText,":");n=n[n.length-1];t=document.getElementById("appointment-card")?.outerText}if(!e)return;o={visaDetails:e,userDetails:JSON.stringify(h()),familyDetails:n,apntDetails:t};a=u(r);if(a){chrome.storage.local.get(["userProfiles"],function(e){let t={},n={createdon:new Date};if(e.hasOwnProperty("userProfiles")){t=JSON.parse(e["userProfiles"])}if(!t.hasOwnProperty(a)){t[a]={}}t[a]={...t[a],...o,...n};if(a in t){if((new Date).getTime()-t[a]["createdon"].getTime()<7*24*60*60*1e3){if("visaPriority"in t[a]){return}}}U().then(e=>{if(e["portalID"]==a&&e["apntType"]){o["visaPriority"]=e["apntType"]}t[a]={...o,...n};chrome.storage.local.set({userProfiles:JSON.stringify(t)})})})}}async function n(){await new Promise(e=>{let t=setInterval(()=>{if(document.readyState==="complete"){clearInterval(t);e()}else{console.log("waiting for document to load")}},1e3)})}function o(){n().then(()=>{document.querySelector("#post_select").addEventListener("change",async function(e){document.querySelector(`#${_}`)?.remove()})})}async function a(){let e=await Swal.fire({title:"Download Appointment Confirmation?",confirmButtonText:"Yes",showCancelButton:true,cancelButtonText:"No",showLoaderOnConfirm:true,preConfirm:r,allowOutsideClick:()=>!Swal.isLoading()});if(!e.isConfirmed)return console.log("step 1 canceled")}async function r(){let t=document.querySelector('[aria-label="Basic Form"]');try{let a;document.querySelectorAll("#view-full-ppn").forEach(e=>e.click());const n=await html2canvas(t,{letterRendering:true,allowTaint:false,useCORS:true,scale:1,width:t.scrollWidth,height:t.scrollHeight,onclone:function(e){let t=e.querySelector('[aria-label="Basic Form"]');t.querySelectorAll("#view-full-ppn").forEach(e=>e.style.display="none");t.querySelectorAll(".section-title:last-of-type + * table").forEach(e=>e.style="table-layout: initial;");t.querySelectorAll("td").forEach(e=>e.style.color="#000000");let n=t.querySelector("#surveyLink");let o=n?.parentElement;o?.removeChild(n);t.style.backgroundColor="white";t.style.boxShadow="none";a=t}});document.querySelectorAll("#view-full-ppn").forEach(e=>e.click());let e=h()["username"].split(" (")[0].trim();html2pdf().set({margin:[10,0,10,0],filename:e+"_VisaAppointment_CHECKVISASLOTS.COM .pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2},pagebreak:{mode:["avoid-all","css","legacy"]},jsPDF:{putOnlyUsedFonts:true,precision:2}}).from(a).save()}catch(M){console.log(M);Swal.fire({title:"Error occurred",text:"There is an error occured while generating PDF",icon:"error"})}}function s(e,t="\n"){let n=[];e.split(t).forEach(e=>{e=e.trim();if(e){n.push(e)}});return n}function f(){const e=document.querySelector("#post_select");return e[e.selectedIndex].text}async function l(e){let o={},a=f(),t=true;if(!e.ScheduleDays?.length){document.getElementById("datepicker-message").innerHTML=`<br><span class="atlas_validation alert alert-danger warning">No Slots Available</span>`;return[]}q(new Date(e.ScheduleDays[0]["Date"]));e.ScheduleDays?.forEach(e=>{let t=new Date(e.Date),n;n=t.toLocaleDateString("en-US",{month:"long",year:"numeric"});if(!o.hasOwnProperty(n)){o[n]={monthYear:n,dates:[],location:a}}o[n].dates.push(String(t.getDate()))});return Object.values(o)}async function i(e){let t=[["Time","Available"]];e.ScheduleEntries?.forEach(e=>{t.push([e.Time,e.EntriesAvailable])});return t}function h(){const e=/appInsights\.setAuthenticatedUserContext\('(.*?)'\)/;const t=document.documentElement.outerHTML.match(e);let n="",o=document.querySelector(".username").outerText;if(t&&t.length>1){n=t[1]}return{email:n,username:o,portal_id:u(o)}}function p(t,n,o,a,r){html2canvas(document.body,{Allowtaint:false,Usecors:true,Scale:2,Width:document.body.scrollWidth,Height:document.body.scrollHeight}).then(e=>{chrome.runtime.sendMessage({resource:t,box:n,imgUri:e.toDataURL("image/png"),portal_id:u(r),slot_page:{slotDetails:o,appointmentTimes:a,slotPageUsername:r}})})}function y(t,n,o,a,r,l={}){let e=document.querySelector("#main_container").parentNode;html2canvas(document.querySelector("#main_container"),{useCORS:true,width:e.width,height:e.height,onclone:function(e){if(e.getElementById(`${_}`)){e.getElementById(`${_}`).style.display="inherit"}e.querySelectorAll("#gm_select .list-group-item").forEach(e=>{e.textContent="CheckVisaSlots.com User"});let t=e.createElement("div");t.style.position="absolute";t.style.top="50%";t.style.left="25%";t.style.transform="rotate(-45deg)";t.style.color="rgba(0, 0, 0, 0.5)";t.style.fontSize="50px";t.style.fontWeight="bold";t.style.zIndex="1000";t.innerHTML="CHECKVISASLOTS.COM";e.querySelectorAll('div[id*="visajar-helper-table"], div[id*="dates-container"]').forEach(e=>e.remove());e.querySelector("#main_container").appendChild(t)}}).then(e=>{chrome.runtime.sendMessage({resource:t,box:n,imgUri:e.toDataURL("image/png"),portal_id:u(r),slot_page:{slotDetails:o,appointmentTimes:a,slotPageUsername:r,slotdetails:l}})})}addEventListener("vSCP",e=>{if(e.detail.resource==="vD"){v(e.detail.data)}else if(e.detail.resource==="vSD"){C(e.detail.data)}else if(e.detail.resource==="vST"){E(e.detail.data)}});let g=false;async function v(o){let a=u(document.querySelector(".username").outerText);chrome.storage.local.get(["userProfiles"],function(e){let t={},n={createdon:new Date};if(e.hasOwnProperty("userProfiles")){t=JSON.parse(e["userProfiles"])}if(!t.hasOwnProperty(a)){t[a]={}}t[a]={...t[a],...{VisaClassID:o["Members"][0]["VisaClassID"],VisaClass:o["Members"][0]["VisaClassName"],userDetails:JSON.stringify(h()),visaPriority:t[a]["visaPriority"]},...n};chrome.storage.local.set({userProfiles:JSON.stringify(t)},function(){g=true})})}let S=[],$="",x={},w=false,b=false;chrome.storage.local.get(["is_sel-1st-slot","is_display-slots"],function(e){w=e["is_sel-1st-slot"];b=e["is_display-slots"]});async function C(e){let t=await l(e),n=f();await chrome.storage.local.set({prev_slot_location:n,prev_slot_dates:e});O(t);if(t.length===0){t=[{location:f()}];y(resource="/push/v5",{},t,[],document.querySelector(".username").outerText)}else if(!w){y(resource="/push/v5",{},t,[],document.querySelector(".username").outerText)}S=t;x=e.ScheduleDays;return S}async function E(e){let t=await i(e);if(t.length>1){await chrome.storage.local.get(["is_sel-1st-slot","is_auto-submit"],function(e){if(e["is_sel-1st-slot"]){T(e["is_auto-submit"]||true)}})}let n={},o=document.querySelector(".username").outerText;y(resource="/push/v5",n,S,t,o,x)}async function q(e){let t=new Date(e),n=t.getFullYear(),o=t.getMonth(),a=t.getDate(),r=t.toLocaleString("default",{month:"short"});let l=new Event("change",{bubbles:true});let i=document.querySelector(".ui-datepicker-year");i.value=n.toString();i.dispatchEvent(l);let s=document.querySelector(".ui-datepicker-month");s.value=o.toString();s.dispatchEvent(l);if(w){document.querySelector(`.ui-datepicker-calendar a[data-date="${a}"]`).click()}}async function T(){document.querySelector('input[type="radio"]').click()}let _=Math.random().toString(36).substr(2,9);if(_[0]>="0"&&_[0]<="9"){_="s"+_}async function O(e){return;let t=document.querySelector("#page_form");if(t){t.querySelector(`#${_}`)?.remove()}let n=document.createElement("table");n.className="table table-bordered table-striped table-hover";let o=document.createElement("thead"),a=document.createElement("tr"),r=document.createElement("th");r.textContent="Month Year";let l=document.createElement("th");l.textContent="Dates";a.appendChild(r);a.appendChild(l);o.appendChild(a);n.appendChild(o);let i=document.createElement("tbody");e.forEach(function(e){let t=document.createElement("tr");let n=document.createElement("td");n.textContent=e.monthYear;let o=document.createElement("td");o.textContent=e.dates.join(", ");t.appendChild(n);t.appendChild(o);i.appendChild(t)});let s=f();if(e.length===0){let e=document.createElement("tr");e.innerHTML=`<td colspan="2" class="text-center">No slots available</td>`;i.appendChild(e)}n.appendChild(i);let c=b?"inherit":"none";let u=`<div id=${_} class="atlas_section mt-3" style="display: ${c}"><div class="row"><div class="col-sm-12 atlas_section_header_row text-white">Overview of available slots at<h2>${s}</h2></div></div><div class="row"><div class="col-sm-12">${n.outerHTML}</div></div></div>`;t.insertAdjacentHTML("beforeend",u);k()}async function B(e){let t=document.querySelector("#page_form");if(t){t.querySelector(`#${_}`)?.remove()}let n=document.createElement("table");n.className="table table-bordered table-striped table-hover";let o=document.createElement("thead"),a=document.createElement("tr"),r=document.createElement("th");r.textContent="Month Year";let l=document.createElement("th");l.textContent="Dates";a.appendChild(r);a.appendChild(l);o.appendChild(a);n.appendChild(o);let i=document.createElement("tbody");e.forEach(function(e){let t=document.createElement("tr");let n=document.createElement("td");n.textContent=e.monthYear;let o=document.createElement("td");o.textContent=e.dates.join(", ");t.appendChild(n);t.appendChild(o);i.appendChild(t)});let s=f();if(e.length===0){let e=document.createElement("tr");e.innerHTML=`<td colspan="2" class="text-center">No slots available</td>`;i.appendChild(e)}n.appendChild(i);let c=`<div id=${_} class="atlas_section mt-3""><div class="row"><div class="col-sm-12 atlas_section_header_row text-white">Overview of available slots at<h2>${s}</h2></div></div><div class="row"><div class="col-sm-12">${n.outerHTML}</div></div><div class="row"><div class="col-sm-12 atlas_section_header_row"><a href="https://checkvisaslots.com/?utm_source=${location.pathname}" target="_blank"><span class="text-white">shown by "Check US Visa Slots" extension</span></a></div></div></div>`;t.insertAdjacentHTML("beforeend",c);await chrome.storage.local.get(["is_display-slots"],function(e){document.querySelector(`#${_}`).style.display=e["is_display-slots"]?"inherit":"none"});k()}function D(e){let t=setInterval(()=>{if(document.querySelector("#signInName")&&document.querySelector("#password")){clearInterval(t);document.querySelector("#signInName").value=e["username"];document.querySelector("#password").value=e["password"];document.querySelector("#extension_atlasCaptchaResponse").focus()}},100)}function P(a){let e=document.querySelectorAll("#attributeList li.Paragraph");if(e.length!==2){setTimeout(()=>{P(a)},500)}n().then({});let r=0;e.forEach(function(e){let t=e.querySelector("p.textInParagraph").textContent.trim(),n=a[t];if(n){var o=e.nextElementSibling.querySelector('input[type="password"]');if(o){o.value=n.trim();r+=1}}if(r===2){document.querySelector("#continue").click()}})}function I(){chrome.storage.local.get(["is_auto-login","loginDetails","securityQuestions"],function(n){if(n["is_auto-login"]){let t=setInterval(()=>{let e=document.querySelector("body").textContent;if(e.indexOf("Generate a new image")>-1||e.indexOf("Captcha text")>-1){D(n["loginDetails"]);clearInterval(t)}else if(e.indexOf("Security Question")>-1){P(n["securityQuestions"]);clearInterval(t)}},200)}})}async function k(){const e=document.querySelector("body").textContent.toLowerCase();let t=[];if(e.indexOf("visajar.com")>-1){t.push("visajar.com")}if(e.indexOf("visaslots.info")>-1){t.push("visaslots.info")}if(t.length>0){await chrome.storage.local.set({crappyExtensions:JSON.stringify(t)});await N()}}async function N(){let e=await chrome.storage.local.get("crappyExtensions").then(e=>{return JSON.parse(e["crappyExtensions"])});const a={"visajar.com":"visajar-helper-table","visaslots.info":"dates-container"};for(let o of e){let e=a[o],t=`<div class="row"><div class="col-sm-12 atlas_section_header_row" style="background-color: darkred"><h2>WARNING!!</h2></div></div<div class="row"><div class="col-sm-12"   <p class="alert alert-danger text-danger">Too many extensions on the same page will slow the page loading. Compared to the 'Check US Visa Slots' extension, the ${o} extension adds no additional value. Follow below steps to <strong>remove ${o} extension</strong>.<ol><li>1. Go to your browser extensions - chrome://extensions</li><li>2. Find the <u>${o}</u> extension</li><li>3. click "Remove" button</li><li>4. Reload this page</li></ol></div></div>`;let n=setInterval(()=>{if(document.querySelector(`#${e}`)){if(e==="dates-container"){document.getElementById(`${e}`).className="atlas_section mt-3"}document.querySelector(`#${e}`).innerHTML=t;clearInterval(n)}},500)}}async function V(){const e=await chrome.runtime.sendMessage({action:"getApntConfDets"});return L(e["apntConfDets"])}async function H(){async function e(){return fetch("https://www.usvisascheduling.com/en-US/appointment-confirmation/").then(e=>e.text()).then(e=>{return e})}return L(await e())}async function U(){return{portalID:u(document.querySelector(".username").outerText),apntType:""}}function L(e){let t=new DOMParser,n,o="",a,r;n=t.parseFromString(e,"text/html");a=n.querySelector("#entity-content table").querySelectorAll("tr");r=u(document.querySelector(".username").outerText);try{for(let t=a.length-1;t>=0;t--){let e=a[t];if(e.textContent.includes("Visa Priority")){o=e.querySelector("td:nth-child(2)").textContent.trim();return{portalID:r,apntType:o}}}}catch(l){console.log("Parse Visa Priority Error",l)}return{portalID:r,apntType:o}}